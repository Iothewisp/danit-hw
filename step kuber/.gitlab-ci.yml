stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH:latest

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ðŸ”§ Building Docker image..."
    - docker build -t $DOCKER_IMAGE .
    - echo "ðŸ” Logging into GitLab Registry..."
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin registry.gitlab.com
    - echo "ðŸ“¦ Pushing image to registry..."
    - docker push $DOCKER_IMAGE

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh bash
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Connecting to $SSH_HOST as $SSH_USER..."
    - ssh $SSH_USER@$SSH_HOST <<EOF
        echo "ðŸ“‚ Switching to project directory..."
        cd /mnt/h/dan-it/STEP\ KUBER
        echo "ðŸ“¦ Deploying Kubernetes manifests..."
        kubectl apply -f k8s/
        echo "ðŸ” Checking pods and services..."
        kubectl get pods
        kubectl get svc
      EOF
